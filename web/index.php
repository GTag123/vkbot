<?php
require('../vendor/autoload.php');

$app = new Silex\Application();
$app['debug'] = true;

// Register the monolog logging service
$app->register(new Silex\Provider\MonologServiceProvider(), array(
  'monolog.logfile' => 'php://stderr',
));

// Our web handlers

$app->get('/', function() use($app) {
  return "Hello world";
});
$app->post('/bot', function() use($app) {
  $data = json_decode(file_get_contents('php://input'));

  if(!$data)
    return "nioh";
  
  if( $data->secret !== getenv('VK_SECRET_TOKEN') && $data->type !== 'confirmation')
    return 'nioh';

  switch($data->type){
    case 'confirmation':
      return getenv('VK_CONFIRMATION_CODE');
      break;
      $anekdots = array(
        '–ö–æ–ª–æ–±–æ–∫ –ø–æ–≤–µ—Å–∏–ª—Å—èüòÑüòÑ',
        '- –ú–∞–º–∞, –æ–¥–µ–≤–∞–π –º–µ–Ω—è –±—ã—Å—Ç—Ä–µ–µ! - –í–æ–≤–æ—á–∫–∞, –∫—É–¥–∞ –∂–µ —Ç—ã —Ç–∞–∫ —Ç–æ—Ä–æ–ø–∏—à—å—Å—è? - –ú–µ–Ω—è –≤ —Å–∞–¥–∏–∫–µ –∂–¥—É—Ç –¥—Ä—É–∑—å—è! - –ò —á—Ç–æ –∂–µ –≤—ã —Ç–∞–º –¥–µ–ª–∞–µ—Ç–µ? - –î–µ—Ä—ë–º—Å—è!üòÑüòÑ',
        '–£—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞:<br>
        - –ü—Ä–µ–∫—Ä–∞—Å–Ω–æ, –í–æ–≤–æ—á–∫–∞, –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫. –ê —Ç—ã —É–≤–µ—Ä–µ–Ω, —á—Ç–æ —Ç–≤–æ–µ–º—É –ø–∞–ø–µ –Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–º–æ–≥–∞–ª!?üòÑüòÑ',
        "–£—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –í–æ–≤–æ—á–∫—É:
        ‚Äì –í–æ–≤–æ—á–∫–∞, –ø–æ—á–µ–º—É –ø—Ç–∏—Ü—ã –ª–µ—Ç—è—Ç –Ω–∞ —é–≥?
        ‚Äì –ü–æ—Ç–æ–º—É —á—Ç–æ –∏–º —Ç—Ä—É–¥–Ω–æ –∏–¥—Ç–∏ —Ç—É–¥–∞ –ø–µ—à–∫–æ–º.üòÑüòÑ",
        "–£—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞:
        ‚Äì –í–æ—Ç –º—É—Ä–∞–≤–µ–π —Ç—Ä—É–¥–∏—Ç—Å—è —Ü–µ–ª—ã–π –¥–µ–Ω—å. –î–µ—Ç–∏, –∞ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Ç–æ–º?
        –í–æ–≤–æ—á–∫–∞:
        ‚Äì –ê –ø–æ—Ç–æ–º –∫–∞–∫–∞—è-–Ω–∏–±—É–¥—å –∑–∞—Ä–∞–∑–∞ –≤–æ–∑—å–º—ë—Ç –∏ —Ä–∞–∑–¥–∞–≤–∏—Ç!üòÑüòÑ",
        "
        –í—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–≤–∞ –µ–∂–∏–∫–∞. –£ –æ–¥–Ω–æ–≥–æ –∑–∞–±–∏–Ω—Ç–æ–≤–∞–Ω–∞ –ª–∞–ø–∫–∞.
        ‚Äì –ß—Ç–æ —Å —Ç–æ–±–æ–π?
        ‚Äì –ù–∏—á–µ–≥–æ. –ü—Ä–æ—Å—Ç–æ —Ö–æ—Ç–µ–ª –ø–æ—á–µ—Å–∞—Ç—å—Å—è.üòÑüòÑ",
        "–ë–µ–∂–∏—Ç –µ–∂–∏–∫ –ø–æ –ª–µ—Å—É, –∞ –Ω–∞–≤—Å—Ç—Ä–µ—á—É –µ–º—É –∑–∞—è—Ü:
        ‚Äì –ï–∂–∏–∫, –∞ –µ–∂–∏–∫, –ø–æ—á–µ–º—É —É —Ç–µ–±—è –∏–≥–æ–ª–∫–∏ —Ç–∞–∫–∏–µ –∂–µ—Å—Ç–∫–∏–µ?
        ‚Äì –ü–æ—á–µ–º—É, –ø–æ—á–µ–º—É! –ù–µ –º—ã–ª—Å—è —è –¥–∞–≤–Ω–æ!üòÑüòÑ",
        "–û—Ç–µ—Ü –≥–æ–≤–æ—Ä–∏—Ç —Å—ã–Ω—É:
        ‚Äì –ü—Ä–∏–¥–µ—Ç—Å—è –º–Ω–µ —Ç–µ–±—è –≤—ã–ø–æ—Ä–æ—Ç—å, —Ö–æ—Ç—è, –º–æ–∂–µ—à—å –ø–æ–≤–µ—Ä–∏—Ç—å, –º–Ω–µ —ç—Ç–æ –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ.
        ‚Äì –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, –∫–æ–º—É —Ç—ã —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∞–≤–∏—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ?üòÑüòÑ"
        );

    case 'message_new':
      if ( $data->object->text == '!–ö—É' || $data->object->text == '!–∫—É' || $data->object->text == '!–ø—Ä–∏–≤–µ—Ç' || $data->object->text == '!–ü—Ä–∏–≤–µ—Ç'){
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=>'–ø—Ä–∏–≤–µ—Ç',
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      } 
      if ( $data->object->text == '!–∞–Ω–µ–∫–¥–æ—Ç' || $data->object->text == '!–ê–Ω–µ–∫–¥–æ—Ç' ){
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=> $anekdots[rand(0, count($anekdots))],
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      } else {
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=>'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! <br> –í–æ—Ç –º–æ–∏ –∫–æ–º–∞–Ω–¥—ã: <br> ;-P !–ø—Ä–∏–≤–µ—Ç - –±–æ—Ç —Å–∫–∞–∂–µ—Ç —Ç–µ–±–µ –ø—Ä–∏–≤–µ—Çüòú',
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      }

      file_get_contents('https://api.vk.com/method/messages.send?' . http_build_query($request_params));
      return 'ok';

      break;
  }
  return "nioh";
});

$app->run();
