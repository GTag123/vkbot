<?php
require('../vendor/autoload.php');
$anekdots = array(
  'ÐšÐ¾Ð»Ð¾Ð±Ð¾Ðº Ð¿Ð¾Ð²ÐµÑÐ¸Ð»ÑÑðŸ˜„ðŸ˜„',
  '- ÐœÐ°Ð¼Ð°, Ð¾Ð´ÐµÐ²Ð°Ð¹ Ð¼ÐµÐ½Ñ Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ! - Ð’Ð¾Ð²Ð¾Ñ‡ÐºÐ°, ÐºÑƒÐ´Ð° Ð¶Ðµ Ñ‚Ñ‹ Ñ‚Ð°Ðº Ñ‚Ð¾Ñ€Ð¾Ð¿Ð¸ÑˆÑŒÑÑ? - ÐœÐµÐ½Ñ Ð² ÑÐ°Ð´Ð¸ÐºÐµ Ð¶Ð´ÑƒÑ‚ Ð´Ñ€ÑƒÐ·ÑŒÑ! - Ð˜ Ñ‡Ñ‚Ð¾ Ð¶Ðµ Ð²Ñ‹ Ñ‚Ð°Ð¼ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ? - Ð”ÐµÑ€Ñ‘Ð¼ÑÑ!ðŸ˜„ðŸ˜„',
  'Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¸Ñ†Ð°:<br>
  - ÐŸÑ€ÐµÐºÑ€Ð°ÑÐ½Ð¾, Ð’Ð¾Ð²Ð¾Ñ‡ÐºÐ°, Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº. Ð Ñ‚Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½, Ñ‡Ñ‚Ð¾ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ Ð¿Ð°Ð¿Ðµ Ð½Ð¸ÐºÑ‚Ð¾ Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ð»!?ðŸ˜„ðŸ˜„',
  "Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¸Ñ†Ð° ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð’Ð¾Ð²Ð¾Ñ‡ÐºÑƒ:
  â€“ Ð’Ð¾Ð²Ð¾Ñ‡ÐºÐ°, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð¿Ñ‚Ð¸Ñ†Ñ‹ Ð»ÐµÑ‚ÑÑ‚ Ð½Ð° ÑŽÐ³?
  â€“ ÐŸÐ¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ð¸Ð¼ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ Ð¸Ð´Ñ‚Ð¸ Ñ‚ÑƒÐ´Ð° Ð¿ÐµÑˆÐºÐ¾Ð¼.ðŸ˜„ðŸ˜„",
  "Ð£Ñ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¸Ñ†Ð°:
  â€“ Ð’Ð¾Ñ‚ Ð¼ÑƒÑ€Ð°Ð²ÐµÐ¹ Ñ‚Ñ€ÑƒÐ´Ð¸Ñ‚ÑÑ Ñ†ÐµÐ»Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ. Ð”ÐµÑ‚Ð¸, Ð° Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð¿Ð¾Ñ‚Ð¾Ð¼?
  Ð’Ð¾Ð²Ð¾Ñ‡ÐºÐ°:
  â€“ Ð Ð¿Ð¾Ñ‚Ð¾Ð¼ ÐºÐ°ÐºÐ°Ñ-Ð½Ð¸Ð±ÑƒÐ´ÑŒ Ð·Ð°Ñ€Ð°Ð·Ð° Ð²Ð¾Ð·ÑŒÐ¼Ñ‘Ñ‚ Ð¸ Ñ€Ð°Ð·Ð´Ð°Ð²Ð¸Ñ‚!ðŸ˜„ðŸ˜„",
  "
  Ð’ÑÑ‚Ñ€ÐµÑ‡Ð°ÑŽÑ‚ÑÑ Ð´Ð²Ð° ÐµÐ¶Ð¸ÐºÐ°. Ð£ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð±Ð¸Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð° Ð»Ð°Ð¿ÐºÐ°.
  â€“ Ð§Ñ‚Ð¾ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹?
  â€“ ÐÐ¸Ñ‡ÐµÐ³Ð¾. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ñ…Ð¾Ñ‚ÐµÐ» Ð¿Ð¾Ñ‡ÐµÑÐ°Ñ‚ÑŒÑÑ.ðŸ˜„ðŸ˜„",
  "Ð‘ÐµÐ¶Ð¸Ñ‚ ÐµÐ¶Ð¸Ðº Ð¿Ð¾ Ð»ÐµÑÑƒ, Ð° Ð½Ð°Ð²ÑÑ‚Ñ€ÐµÑ‡Ñƒ ÐµÐ¼Ñƒ Ð·Ð°ÑÑ†:
  â€“ Ð•Ð¶Ð¸Ðº, Ð° ÐµÐ¶Ð¸Ðº, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ñƒ Ñ‚ÐµÐ±Ñ Ð¸Ð³Ð¾Ð»ÐºÐ¸ Ñ‚Ð°ÐºÐ¸Ðµ Ð¶ÐµÑÑ‚ÐºÐ¸Ðµ?
  â€“ ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ, Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ! ÐÐµ Ð¼Ñ‹Ð»ÑÑ Ñ Ð´Ð°Ð²Ð½Ð¾!ðŸ˜„ðŸ˜„",
  "ÐžÑ‚ÐµÑ† Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ ÑÑ‹Ð½Ñƒ:
  â€“ ÐŸÑ€Ð¸Ð´ÐµÑ‚ÑÑ Ð¼Ð½Ðµ Ñ‚ÐµÐ±Ñ Ð²Ñ‹Ð¿Ð¾Ñ€Ð¾Ñ‚ÑŒ, Ñ…Ð¾Ñ‚Ñ, Ð¼Ð¾Ð¶ÐµÑˆÑŒ Ð¿Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ, Ð¼Ð½Ðµ ÑÑ‚Ð¾ Ð½ÐµÐ¿Ñ€Ð¸ÑÑ‚Ð½Ð¾.
  â€“ Ð’ Ñ‚Ð°ÐºÐ¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ, ÐºÐ¾Ð¼Ñƒ Ñ‚Ñ‹ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ Ð´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¸Ðµ?ðŸ˜„ðŸ˜„"
  );
$app = new Silex\Application();
$app['debug'] = true;

// Register the monolog logging service
$app->register(new Silex\Provider\MonologServiceProvider(), array(
  'monolog.logfile' => 'php://stderr',
));

// Our web handlers

$app->get('/', function() use($app) {
  return "Hello world";
});
$app->post('/bot', function() use($app) {
  $data = json_decode(file_get_contents('php://input'));

  if(!$data)
    return "nioh";
  
  if( $data->secret !== getenv('VK_SECRET_TOKEN') && $data->type !== 'confirmation')
    return 'nioh';

  switch($data->type){
    case 'confirmation':
      return getenv('VK_CONFIRMATION_CODE');
      break;
      

    case 'message_new':
      if ( $data->object->text == '!ÐšÑƒ' || $data->object->text == '!ÐºÑƒ' || $data->object->text == '!Ð¿Ñ€Ð¸Ð²ÐµÑ‚' || $data->object->text == '!ÐŸÑ€Ð¸Ð²ÐµÑ‚'){
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=>'Ð¿Ñ€Ð¸Ð²ÐµÑ‚',
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      } 
      elseif ( $data->object->text == '!Ð°Ð½ÐµÐºÐ´Ð¾Ñ‚' || $data->object->text == '!ÐÐ½ÐµÐºÐ´Ð¾Ñ‚' ){
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=> "{$anekdots[rand(0, count($anekdots)-1)]}",
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      } else {
        $request_params = array(
          'user_id' => "{$data->object->from_id}",
          'message'=>'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! <br> Ð’Ð¾Ñ‚ Ð¼Ð¾Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹: <br> ;-P !Ð¿Ñ€Ð¸Ð²ÐµÑ‚ - Ð±Ð¾Ñ‚ ÑÐºÐ°Ð¶ÐµÑ‚ Ñ‚ÐµÐ±Ðµ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ðŸ˜œ',
          'access_token' => '18d28ce6782d1c964c4bac21f4fd054378c65e739089d1bcae856947b32657436f5c2d06faa5179289e08',
          'v' => '5.80'
        );
      }

      file_get_contents('https://api.vk.com/method/messages.send?' . http_build_query($request_params));
      return 'ok';

      break;
  }
  return "nioh";
});

$app->run();
